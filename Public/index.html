<!DOCTYPE html>
<html lang="zh-TW">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>程式教學平台 - 學生註冊系統</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="responsive.css">
    <link rel="stylesheet" href="visual.css">
    <link rel="stylesheet" href="animations.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>

  <body>
    <div class="container">
      <div class="registration-card">
        <div class="header">
          <div class="logo">
            <i class="fas fa-code"></i>
            <h1>程式教學平台</h1>
          </div>
          <p class="subtitle">歡迎加入我們的程式學習社群</p>
        </div>

        <form id="registrationForm" class="registration-form">
          <div class="form-section">
            <h3><i class="fas fa-user"></i> 基本資料</h3>

            <div class="form-group">
              <label for="studentId">學號 *</label>
              <input type="text" id="studentId" name="studentId" placeholder="請輸入8位數字" maxlength="8" pattern="[0-9]{8}"
                required>
              <span class="error-message" id="studentIdError"></span>
            </div>

            <div class="form-group">
              <label for="fullName">姓名 *</label>
              <input type="text" id="fullName" name="fullName" required>
              <span class="error-message" id="fullNameError"></span>
            </div>

            <div class="form-group">
              <label for="email">電子郵件 *</label>
              <input type="email" id="email" name="email" required>
              <span class="error-message" id="emailError"></span>
            </div>

            <div class="form-group">
              <label for="phone">聯絡電話 *</label>
              <input type="tel" id="phone" name="phone" required>
              <span class="error-message" id="phoneError"></span>
            </div>

            <div class="form-group">
              <label for="birthDate">出生日期 *</label>
              <input type="date" id="birthDate" name="birthDate" required>
              <span class="error-message" id="birthDateError"></span>
            </div>

            <div class="form-group">
              <label for="gender">性別 *</label>
              <select id="gender" name="gender" required>
                <option value="">請選擇性別</option>
                <option value="male">男</option>
                <option value="female">女</option>
                <option value="other">其他</option>
              </select>
              <span class="error-message" id="genderError"></span>
            </div>
          </div>

          <div class="form-section">
            <h3><i class="fas fa-graduation-cap"></i> 學習資訊</h3>

            <div class="form-group">
              <label for="department">科系 *</label>
              <select id="department" name="department" required>
                <option value="">請選擇科系</option>
                <optgroup label="資訊相關科系">
                  <option value="資訊工程系">資訊工程系</option>
                  <option value="資訊管理系">資訊管理系</option>
                  <option value="資訊科學系">資訊科學系</option>
                  <option value="資訊網路系">資訊網路系</option>
                  <option value="資訊傳播系">資訊傳播系</option>
                  <option value="電腦科學系">電腦科學系</option>
                  <option value="軟體工程系">軟體工程系</option>
                  <option value="數據科學系">數據科學系</option>
                  <option value="人工智慧系">人工智慧系</option>
                  <option value="數位媒體設計系">數位媒體設計系</option>
                  <option value="資訊安全系">資訊安全系</option>
                </optgroup>
                <optgroup label="工程科系">
                  <option value="電機工程系">電機工程系</option>
                  <option value="電子工程系">電子工程系</option>
                  <option value="機械工程系">機械工程系</option>
                  <option value="工業工程系">工業工程系</option>
                  <option value="土木工程系">土木工程系</option>
                  <option value="化學工程系">化學工程系</option>
                  <option value="材料工程系">材料工程系</option>
                </optgroup>
                <optgroup label="商管科系">
                  <option value="企業管理系">企業管理系</option>
                  <option value="會計系">會計系</option>
                  <option value="財務金融系">財務金融系</option>
                  <option value="國際貿易系">國際貿易系</option>
                  <option value="行銷管理系">行銷管理系</option>
                  <option value="人力資源管理系">人力資源管理系</option>
                </optgroup>
                <optgroup label="其他科系">
                  <option value="應用統計系">應用統計系</option>
                  <option value="建築系">建築系</option>
                  <option value="其他">其他</option>
                </optgroup>
              </select>
              <span class="error-message" id="departmentError"></span>
            </div>

            <div class="form-group">
              <label for="grade">年級 *</label>
              <select id="grade" name="grade" required>
                <option value="">請選擇年級</option>
                <option value="1">一年級</option>
                <option value="2">二年級</option>
                <option value="3">三年級</option>
                <option value="4">四年級</option>
                <option value="graduate">研究所</option>
              </select>
              <span class="error-message" id="gradeError"></span>
            </div>

            <div class="form-group">
              <label for="programmingLevel">程式設計經驗 *</label>
              <select id="programmingLevel" name="programmingLevel" required>
                <option value="">請選擇經驗等級</option>
                <option value="beginner">初學者 (無經驗)</option>
                <option value="basic">基礎 (1-6個月)</option>
                <option value="intermediate">中級 (6個月-2年)</option>
                <option value="advanced">高級 (2年以上)</option>
              </select>
              <span class="error-message" id="programmingLevelError"></span>
            </div>

            <div class="form-group">
              <label for="learningGoals">學習目標</label>
              <textarea id="learningGoals" name="learningGoals" rows="4" placeholder="請描述您的學習目標和期望..."></textarea>
            </div>
          </div>

          <div class="form-section">
            <h3><i class="fas fa-lock"></i> 帳戶設定</h3>

            <div class="form-group">
              <label for="username">使用者名稱 *</label>
              <input type="text" id="username" name="username" required>
              <span class="error-message" id="usernameError"></span>
            </div>

            <div class="form-group">
              <label for="password">密碼 *</label>
              <div class="password-requirements">
                <small><strong>密碼規則：</strong></small>
                <ul class="password-rules">
                  <li>至少8個字符</li>
                  <li>至少包含8個英文字母和數字組合</li>
                  <li>第一個字母必須是大寫</li>
                  <li>必須包含1個特殊符號 (# 或 $ 或 * 或 @)</li>
                </ul>
              </div>
              <div class="password-input">
                <input type="password" id="password" name="password" required>
                <button type="button" class="toggle-password" onclick="togglePassword('password')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <span class="error-message" id="passwordError"></span>
            </div>

            <div class="form-group">
              <label for="confirmPassword">確認密碼 *</label>
              <div class="password-input">
                <input type="password" id="confirmPassword" name="confirmPassword" required>
                <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <span class="error-message" id="confirmPasswordError"></span>
            </div>
          </div>

          <div class="form-section">
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                <span class="checkmark"></span>
                我同意 <a href="#" class="link">服務條款</a> 和 <a href="#" class="link">隱私政策</a> *
              </label>
              <span class="error-message" id="agreeTermsError"></span>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="newsletter" name="newsletter">
                <span class="checkmark"></span>
                訂閱課程更新和學習資源通知
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
              <i class="fas fa-undo"></i> 重設
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-user-plus"></i> 註冊帳戶
            </button>
          </div>
        </form>

        <div class="login-link">
          <p>已經有帳戶了？ <a href="login.html" class="link">立即登入</a></p>
        </div>

        <div class="login-link" style="margin-top: 20px;">
          <p style="font-size: 0.85rem; color: #999;">
            遇到問題？ <a href="clear-data.html" class="link" style="color: #e74c3c;">清除所有資料</a>
          </p>
        </div>
      </div>
    </div>

    <script src="../Private/database/secureDB.js"></script>
    <script src="../Private/database/userRepository.js"></script>
    <script src="../Private/database/sessionRepository.js"></script>
    <script src="../Private/data/coursesData.js"></script>
    <script src="../Private/auth/api.js"></script>
    <script src="../Private/auth/session.js"></script>
    <script src="../Private/favorites/favoritesAPI.js"></script>
    <script src="animations.js"></script>
    <script>

      // 密碼顯示/隱藏切換
      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');

        if (field.type === 'password') {
          field.type = 'text';
          icon.className = 'fas fa-eye-slash';
        } else {
          field.type = 'password';
          icon.className = 'fas fa-eye';
        }
      }

      // 表單驗證
      function validateForm() {
        let isValid = true;
        const errors = {};

        // 清除之前的錯誤訊息
        document.querySelectorAll('.error-message').forEach(error => {
          error.textContent = '';
        });

        // 學號驗證
        const studentId = document.getElementById('studentId').value.trim();
        if (!studentId) {
          errors.studentId = '請輸入學號';
          isValid = false;
        } else if (!/^\d{8}$/.test(studentId)) {
          errors.studentId = '學號必須為8位數字';
          isValid = false;
        }

        // 姓名驗證
        const fullName = document.getElementById('fullName').value.trim();
        if (!fullName) {
          errors.fullName = '請輸入姓名';
          isValid = false;
        } else if (fullName.length < 2) {
          errors.fullName = '姓名至少需要2個字符';
          isValid = false;
        }

        // 電子郵件驗證
        const email = document.getElementById('email').value.trim();
        if (!email) {
          errors.email = '請輸入電子郵件';
          isValid = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          errors.email = '請輸入有效的電子郵件格式';
          isValid = false;
        }

        // 電話驗證
        const phone = document.getElementById('phone').value.trim();
        if (!phone) {
          errors.phone = '請輸入聯絡電話';
          isValid = false;
        } else if (!/^[0-9\-\+\(\)\s]{8,15}$/.test(phone)) {
          errors.phone = '請輸入有效的電話號碼';
          isValid = false;
        }

        // 出生日期驗證
        const birthDate = document.getElementById('birthDate').value;
        if (!birthDate) {
          errors.birthDate = '請選擇出生日期';
          isValid = false;
        } else {
          const today = new Date();
          const birth = new Date(birthDate);
          const age = today.getFullYear() - birth.getFullYear();
          if (age < 16 || age > 100) {
            errors.birthDate = '年齡必須在16-100歲之間';
            isValid = false;
          }
        }

        // 密碼驗證
        const password = document.getElementById('password').value;
        if (!password) {
          errors.password = '請輸入密碼';
          isValid = false;
        } else {
          // 檢查密碼規則
          const hasMinLength = password.length >= 8;
          const hasUpperCase = /[A-Z]/.test(password);
          const hasLowerCase = /[a-z]/.test(password);
          const hasNumbers = /\d/.test(password);
          const hasSpecialChar = /[#$*@]/.test(password);
          const startsWithCapital = /^[A-Z]/.test(password);
          const hasAlphanumeric = /[A-Za-z0-9]/.test(password);

          // 計算英文字母和數字的總數
          const alphanumericCount = (password.match(/[A-Za-z0-9]/g) || []).length;

          if (!hasMinLength) {
            errors.password = '密碼至少需要8個字符';
            isValid = false;
          } else if (!startsWithCapital) {
            errors.password = '密碼第一個字母必須是大寫';
            isValid = false;
          } else if (alphanumericCount < 8) {
            errors.password = '密碼至少需要包含8個英文字母和數字組合';
            isValid = false;
          } else if (!hasSpecialChar) {
            errors.password = '密碼必須包含至少1個特殊符號 (# 或 $ 或 * 或 @)';
            isValid = false;
          } else if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
            errors.password = '密碼必須包含大小寫字母和數字';
            isValid = false;
          }
        }

        // 確認密碼驗證
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (!confirmPassword) {
          errors.confirmPassword = '請確認密碼';
          isValid = false;
        } else if (password !== confirmPassword) {
          errors.confirmPassword = '密碼不一致';
          isValid = false;
        }

        // 服務條款同意驗證
        if (!document.getElementById('agreeTerms').checked) {
          errors.agreeTerms = '請同意服務條款和隱私政策';
          isValid = false;
        }

        // 顯示錯誤訊息
        Object.keys(errors).forEach(field => {
          const errorElement = document.getElementById(field + 'Error');
          if (errorElement) {
            errorElement.textContent = errors[field];
          }
        });

        return isValid;
      }

      // 表單提交處理
      document.getElementById('registrationForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        if (validateForm()) {
          // 收集表單資料
          const formData = new FormData(this);
          const data = {};

          // 基本資料
          data.studentId = formData.get('studentId');
          data.fullName = formData.get('fullName');
          data.email = formData.get('email');
          data.phone = formData.get('phone');
          data.birthDate = formData.get('birthDate');
          data.gender = formData.get('gender');

          // 學習資訊
          data.department = formData.get('department');
          data.grade = formData.get('grade');
          data.programmingLevel = formData.get('programmingLevel');
          data.learningGoals = formData.get('learningGoals');

          // 帳戶設定
          data.username = formData.get('username');
          data.password = formData.get('password');
          data.newsletter = formData.get('newsletter') === 'on';

          try {
            // 顯示載入狀態
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 註冊中...';
            submitBtn.disabled = true;

            // 使用認證 API 註冊
            const result = await window.authAPI.signup(data);

            if (result.user_id && result.token) {
              // Signup 已經創建了 token 和 session，直接設置 session manager
              window.sessionManager.token = result.token;
              window.sessionManager.currentUser = result.user;
              localStorage.setItem('auth_token', result.token);

              // 觸發登入事件
              window.sessionManager.dispatchEvent('login', { user: result.user });

              alert('註冊成功！歡迎加入程式教學平台！');
              // 跳轉到儀表板
              window.location.href = 'dashboard.html';
            } else {
              throw new Error('註冊失敗');
            }
          } catch (error) {
            console.error('註冊錯誤:', error);
            alert('註冊失敗：' + error.message);
          } finally {
            // 恢復按鈕狀態
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        }
      });

      // 重設表單
      function resetForm() {
        document.getElementById('registrationForm').reset();
        document.querySelectorAll('.error-message').forEach(error => {
          error.textContent = '';
        });
      }

      // 實時學號驗證
      function validateStudentIdRealTime() {
        const studentIdInput = document.getElementById('studentId');
        const studentId = studentIdInput.value.trim();
        const errorElement = document.getElementById('studentIdError');

        if (studentId.length === 0) {
          errorElement.textContent = '';
          return;
        }

        // 檢查長度
        if (studentId.length < 8) {
          errorElement.textContent = `學號必須為8位數字 (目前：${studentId.length}位)`;
          return;
        }

        if (studentId.length > 8) {
          errorElement.textContent = '學號超過8位數字';
          return;
        }

        // 檢查是否為純數字
        if (!/^\d{8}$/.test(studentId)) {
          errorElement.textContent = '學號只能包含數字';
          return;
        }

        // 清空錯誤訊息如果格式正確
        if (/^\d{8}$/.test(studentId)) {
          errorElement.textContent = '';
        }
      }

      // 學號輸入限制：只允許數字
      function restrictStudentIdInput(event) {
        const input = event.target;
        // 只允許數字，並且限制最多8位
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value.length > 8) {
          input.value = input.value.substring(0, 8);
        }
      }

      // 實時密碼驗證
      function validatePasswordRealTime() {
        const password = document.getElementById('password').value;
        const errorElement = document.getElementById('passwordError');

        if (password.length === 0) {
          errorElement.textContent = '';
          return;
        }

        // 檢查密碼規則
        const hasMinLength = password.length >= 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[#$*@]/.test(password);
        const startsWithCapital = /^[A-Z]/.test(password);

        // 計算英文字母和數字的總數
        const alphanumericCount = (password.match(/[A-Za-z0-9]/g) || []).length;

        let errorMessage = '';

        if (!hasMinLength) {
          errorMessage = '密碼至少需要8個字符';
        } else if (!startsWithCapital) {
          errorMessage = '密碼第一個字母必須是大寫';
        } else if (alphanumericCount < 8) {
          errorMessage = '密碼至少需要包含8個英文字母和數字組合';
        } else if (!hasSpecialChar) {
          errorMessage = '密碼必須包含至少1個特殊符號 (# 或 $ 或 * 或 @)';
        } else if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
          errorMessage = '密碼必須包含大小寫字母和數字';
        }

        errorElement.textContent = errorMessage;
      }

      // 切換課程收藏狀態
      function toggleCourseFavorite(courseId, event) {
        event.preventDefault();
        event.stopPropagation();

        // 如果用戶已登入，可以添加到收藏
        if (window.sessionManager.isLoggedIn()) {
          const user = window.sessionManager.getCurrentUser();
          const result = window.favoritesAPI.toggleFavorite(user.id, courseId);

          if (result.success) {
            updateFavoriteButton(courseId, result.success);
            showNotification(result.message, 'success');
          } else {
            showNotification(result.message, 'error');
          }
        } else {
          // 如果未登入，提示先登入
          showNotification('請先登入以使用收藏功能', 'info');
        }
      }

      // 更新收藏按鈕狀態
      function updateFavoriteButton(courseId, isFavorite) {
        const button = document.querySelector(`button[onclick*="${courseId}"]`);
        if (button) {
          if (isFavorite) {
            button.classList.add('active');
            button.innerHTML = '<i class="fas fa-heart"></i>';
          } else {
            button.classList.remove('active');
            button.innerHTML = '<i class="far fa-heart"></i>';
          }
        }
      }

      // 顯示通知
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

        document.body.appendChild(notification);

        // 顯示動畫
        setTimeout(() => notification.classList.add('show'), 100);

        // 自動移除
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // 頁面載入時初始化
      document.addEventListener('DOMContentLoaded', function () {
        // 檢查是否已經登入
        if (window.sessionManager.isLoggedIn()) {
          alert('您已經登入，正在跳轉到儀表板...');
          window.location.href = 'dashboard.html';
          return;
        }

        // 添加實時學號驗證
        document.getElementById('studentId').addEventListener('input', validateStudentIdRealTime);
        document.getElementById('studentId').addEventListener('keypress', restrictStudentIdInput);
        document.getElementById('studentId').addEventListener('paste', restrictStudentIdInput);

        // 添加實時密碼驗證
        document.getElementById('password').addEventListener('input', validatePasswordRealTime);
      });
    </script>
  </body>

</html>