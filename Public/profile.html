<!DOCTYPE html>
<html lang="zh-TW">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼æ•™å­¸å¹³å° - å€‹äººè³‡æ–™</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="responsive.css">
    <link rel="stylesheet" href="visual.css">
    <link rel="stylesheet" href="animations.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>

  <body>
    <div class="container">
      <!-- å°èˆªæ¬„ -->
      <nav class="navbar">
        <div class="nav-brand">
          <i class="fas fa-code"></i>
          <span>ç¨‹å¼æ•™å­¸å¹³å°</span>
        </div>
        <div class="nav-menu">
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt"></i> å„€è¡¨æ¿
          </a>
          <a href="favorites.html" class="nav-link">
            <i class="fas fa-heart"></i> æˆ‘çš„æ”¶è—
          </a>
          <a href="courses.html" class="nav-link">
            <i class="fas fa-book"></i> èª²ç¨‹
          </a>
          <a href="#profile" class="nav-link active">
            <i class="fas fa-user"></i> å€‹äººè³‡æ–™
          </a>
        </div>
        <div class="nav-user">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="userName">è¼‰å…¥ä¸­...</span>
          </div>
          <button class="btn btn-outline" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> ç™»å‡º
          </button>
        </div>
      </nav>

      <!-- ä¸»è¦å…§å®¹ -->
      <main class="main-content">
        <!-- å€‹äººè³‡æ–™æ¨™é¡Œ -->
        <div class="welcome-section">
          <h1><i class="fas fa-user-circle"></i> å€‹äººè³‡æ–™</h1>
          <p>ç®¡ç†æ‚¨çš„å€‹äººè³‡è¨Šå’Œå­¸ç¿’åå¥½</p>
        </div>

        <!-- å€‹äººè³‡æ–™å¡ç‰‡ -->
        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-info">
              <h2 id="profileName">è¼‰å…¥ä¸­...</h2>
              <p id="profileEmail">è¼‰å…¥ä¸­...</p>
              <div class="profile-stats">
                <div class="stat-item">
                  <span class="stat-number" id="totalCourses">0</span>
                  <span class="stat-label">å·²é¸èª²ç¨‹</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number" id="favoriteCount">0</span>
                  <span class="stat-label">æ”¶è—èª²ç¨‹</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number" id="learningDays">0</span>
                  <span class="stat-label">å­¸ç¿’å¤©æ•¸</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å€‹äººè³‡è¨Šç·¨è¼¯å€åŸŸ -->
        <div class="profile-sections">
          <!-- åŸºæœ¬è³‡è¨Š -->
          <div class="profile-section">
            <div class="section-header">
              <h3><i class="fas fa-user"></i> åŸºæœ¬è³‡è¨Š</h3>
              <button class="btn btn-outline" onclick="toggleEdit('basicInfo')">
                <i class="fas fa-edit"></i> ç·¨è¼¯
              </button>
            </div>
            <div class="section-content">
              <div class="info-grid">
                <div class="info-item">
                  <label>å§“å</label>
                  <input type="text" id="fullName" readonly>
                </div>
                <div class="info-item">
                  <label>ä½¿ç”¨è€…åç¨±</label>
                  <input type="text" id="username" readonly>
                </div>
                <div class="info-item">
                  <label>é›»å­éƒµä»¶</label>
                  <input type="email" id="email" readonly>
                </div>
                <div class="info-item">
                  <label>é›»è©±è™Ÿç¢¼</label>
                  <input type="tel" id="phone" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- å­¸ç¿’åå¥½ -->
          <div class="profile-section">
            <div class="section-header">
              <h3><i class="fas fa-graduation-cap"></i> å­¸ç¿’åå¥½</h3>
              <button class="btn btn-outline" onclick="toggleEdit('learningPrefs')">
                <i class="fas fa-edit"></i> ç·¨è¼¯
              </button>
            </div>
            <div class="section-content">
              <div class="info-grid">
                <div class="info-item">
                  <label>ç¨‹å¼ç¶“é©—ç¨‹åº¦</label>
                  <select id="programmingLevel" disabled>
                    <option value="beginner">åˆå­¸è€…</option>
                    <option value="intermediate">ä¸­ç´š</option>
                    <option value="advanced">é€²éš</option>
                  </select>
                </div>
                <div class="info-item full-width">
                  <label>å­¸ç¿’ç›®æ¨™</label>
                  <textarea id="learningGoals" rows="4" readonly placeholder="é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•è¨­å®šæ‚¨çš„å­¸ç¿’ç›®æ¨™"></textarea>
                  <div class="goals-templates" style="margin-top: 10px; display: none;" id="goalsTemplates">
                    <label style="font-size: 0.9rem; color: #667eea; margin-bottom: 8px; display: block;">
                      <i class="fas fa-lightbulb"></i> å­¸ç¿’ç›®æ¨™ç¯„æœ¬ï¼ˆé»æ“Šä½¿ç”¨ï¼‰ï¼š
                    </label>
                    <div class="template-buttons">
                      <button type="button" class="template-btn"
                        onclick="setLearningGoal('æˆç‚ºå…¨ç«¯é–‹ç™¼å·¥ç¨‹å¸«ï¼ŒæŒæ¡å‰ç«¯èˆ‡å¾Œç«¯æŠ€è¡“ï¼Œå»ºç«‹å®Œæ•´çš„å°ˆæ¡ˆç¶“é©—')">
                        ğŸ¯ æˆç‚ºå…¨ç«¯é–‹ç™¼å·¥ç¨‹å¸«
                      </button>
                      <button type="button" class="template-btn"
                        onclick="setLearningGoal('åŠ å¼·è³‡æ–™çµæ§‹èˆ‡æ¼”ç®—æ³•èƒ½åŠ›ï¼Œæå‡ç¨‹å¼è¨­è¨ˆæ•ˆç‡å’Œå•é¡Œè§£æ±ºæŠ€å·§')">
                        ğŸ’¡ æå‡æ¼”ç®—æ³•èƒ½åŠ›
                      </button>
                      <button type="button" class="template-btn"
                        onclick="setLearningGoal('å­¸ç¿’æœ€æ–°çš„å‰ç«¯æ¡†æ¶ï¼ŒåŒ…æ‹¬ Reactã€Vue ç­‰ç¾ä»£å‰ç«¯æŠ€è¡“')">
                        âš›ï¸ æŒæ¡ç¾ä»£å‰ç«¯æ¡†æ¶
                      </button>
                      <button type="button" class="template-btn"
                        onclick="setLearningGoal('å­¸ç¿’é›²ç«¯é‹ç®—å’Œ DevOps å·¥å…·ï¼Œæå‡ç³»çµ±éƒ¨ç½²å’Œç®¡ç†èƒ½åŠ›')">
                        â˜ï¸ å­¸ç¿’é›²ç«¯æŠ€è¡“
                      </button>
                      <button type="button" class="template-btn" onclick="setLearningGoal('å»ºç«‹å€‹äººä½œå“é›†ï¼Œç´¯ç©å¯¦æˆ°ç¶“é©—ï¼Œç‚ºæ±‚è·åšå¥½æº–å‚™')">
                        ğŸ“š å»ºç«‹ä½œå“é›†
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="info-item full-width">
                <label>æ„Ÿèˆˆè¶£çš„èª²ç¨‹</label>
                <div class="selected-courses" id="selectedCourses"
                  style="min-height: 50px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                  <!-- é¸ä¸­çš„èª²ç¨‹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                <button type="button" class="btn btn-outline" onclick="showCourseSelectionModal()" style="width: 100%;">
                  <i class="fas fa-plus"></i> æ·»åŠ /ç®¡ç†æ„Ÿèˆˆè¶£çš„èª²ç¨‹
                </button>
              </div>
            </div>
          </div>

          <!-- èª²ç¨‹é¸æ“‡æ¨¡æ…‹æ¡† -->
          <div id="courseSelectionModal" class="modal" style="display: none;">
            <div class="modal-content">
              <div class="modal-header">
                <h3><i class="fas fa-book"></i> é¸æ“‡æ„Ÿèˆˆè¶£çš„èª²ç¨‹</h3>
                <button class="modal-close" onclick="closeCourseSelectionModal()">&times;</button>
              </div>
              <div class="modal-body">
                <div class="courses-grid-selection" id="modalCourseList">
                  <!-- èª²ç¨‹é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCourseSelectionModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSelectedCourses()">å„²å­˜</button>
              </div>
            </div>
          </div>

          <!-- å¸³æˆ¶è¨­å®š -->
          <div class="profile-section">
            <div class="section-header">
              <h3><i class="fas fa-cog"></i> å¸³æˆ¶è¨­å®š</h3>
            </div>
            <div class="section-content">
              <div class="settings-list">
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>è®Šæ›´å¯†ç¢¼</h4>
                    <p>å®šæœŸæ›´æ–°æ‚¨çš„å¯†ç¢¼ä»¥ä¿è­·å¸³æˆ¶å®‰å…¨</p>
                  </div>
                  <button class="btn btn-outline" onclick="changePassword()">
                    <i class="fas fa-key"></i> è®Šæ›´
                  </button>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>é€šçŸ¥è¨­å®š</h4>
                    <p>ç®¡ç†æ‚¨æ¥æ”¶çš„é€šçŸ¥é¡å‹</p>
                  </div>
                  <button class="btn btn-outline" onclick="notificationSettings()">
                    <i class="fas fa-bell"></i> è¨­å®š
                  </button>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>è³‡æ–™åŒ¯å‡º</h4>
                    <p>ä¸‹è¼‰æ‚¨çš„å€‹äººè³‡æ–™å’Œå­¸ç¿’è¨˜éŒ„</p>
                  </div>
                  <button class="btn btn-outline" onclick="exportData()">
                    <i class="fas fa-download"></i> åŒ¯å‡º
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="profile-actions">
          <button class="btn btn-primary" onclick="saveProfile()">
            <i class="fas fa-save"></i> å„²å­˜è®Šæ›´
          </button>
          <button class="btn btn-secondary" onclick="resetProfile()">
            <i class="fas fa-undo"></i> é‡è¨­
          </button>
        </div>
      </main>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="../Private/database/secureDB.js"></script>
    <script src="../Private/database/userRepository.js"></script>
    <script src="../Private/database/sessionRepository.js"></script>
    <script src="../Private/data/coursesData.js"></script>
    <script src="../Private/auth/api.js"></script>
    <script src="../Private/auth/session.js"></script>
    <script src="../Private/favorites/favoritesAPI.js"></script>
    <script type="module" src="../Private/data/courseData.ts"></script>
    <script src="animations.js"></script>

    <script>
      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let courses = [];
      let isEditing = {
        basicInfo: false,
        learningPrefs: false
      };

      // DOM å…ƒç´ 
      const userName = document.getElementById('userName');
      const profileName = document.getElementById('profileName');
      const profileEmail = document.getElementById('profileEmail');
      const totalCourses = document.getElementById('totalCourses');
      const favoriteCount = document.getElementById('favoriteCount');
      const learningDays = document.getElementById('learningDays');

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async function () {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (!window.sessionManager.isLoggedIn()) {
          alert('è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å€‹äººè³‡æ–™');
          window.location.href = 'login.html';
          return;
        }

        // è¼‰å…¥èª²ç¨‹è³‡æ–™
        await loadCourseData();

        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        loadUserProfile();

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        loadUserStats();
      });

      // è¼‰å…¥èª²ç¨‹è³‡æ–™
      async function loadCourseData() {
        try {
          const courseModule = await import('../Private/data/courseData.ts');
          courses = courseModule.courses;
          console.log('èª²ç¨‹è³‡æ–™è¼‰å…¥æˆåŠŸ:', courses.length, 'å€‹èª²ç¨‹');
        } catch (error) {
          console.warn('ES6 module import failed, using fallback:', error);
          if (window.CourseData && window.CourseData.courses) {
            courses = window.CourseData.courses;
            console.log('ä½¿ç”¨å…¨åŸŸèª²ç¨‹è³‡æ–™:', courses.length, 'å€‹èª²ç¨‹');
          }
        }
      }

      // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
      function loadUserProfile() {
        currentUser = window.sessionManager.getCurrentUser();
        if (!currentUser) {
          console.error('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
          return;
        }

        // æ›´æ–°å°èˆªæ¬„
        userName.textContent = currentUser.fullName || currentUser.username;
        profileName.textContent = currentUser.fullName || currentUser.username;
        profileEmail.textContent = currentUser.email || 'æœªè¨­å®š';

        // æ›´æ–°åŸºæœ¬è³‡è¨Š
        document.getElementById('fullName').value = currentUser.fullName || '';
        document.getElementById('username').value = currentUser.username || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('phone').value = currentUser.phone || '';

        // æ›´æ–°å­¸ç¿’åå¥½
        document.getElementById('programmingLevel').value = currentUser.programmingLevel || 'beginner';
        document.getElementById('learningGoals').value = currentUser.learningGoals || '';

        // æ›´æ–°æ„Ÿèˆˆè¶£çš„èª²ç¨‹
        updateSelectedCourses();
      }

      // æ›´æ–°é¸ä¸­çš„èª²ç¨‹é¡¯ç¤º
      function updateSelectedCourses() {
        const selectedCoursesDiv = document.getElementById('selectedCourses');
        const interestedCourses = currentUser.interestedCourses || [];

        if (interestedCourses.length === 0) {
          selectedCoursesDiv.innerHTML = '<p class="no-courses">å°šæœªé¸æ“‡ä»»ä½•èª²ç¨‹</p>';
          return;
        }

        selectedCoursesDiv.innerHTML = interestedCourses.map(courseTitle => {
          const course = courses.find(c => c.title === courseTitle);
          if (course) {
            return `
                        <div class="course-tag">
                            <span class="course-title">${course.title}</span>
                            <span class="course-level level-${course.level === 'é€²éš' ? 'advanced' : course.level === 'ä¸­ç´š' ? 'intermediate' : 'beginner'}">${course.level}</span>
                        </div>
                    `;
          }
          return `
                    <div class="course-tag">
                        <span class="course-title">${courseTitle}</span>
                    </div>
                `;
        }).join('');
      }

      // è¼‰å…¥ä½¿ç”¨è€…çµ±è¨ˆ
      async function loadUserStats() {
        try {
          // è¼‰å…¥æ”¶è—æ•¸é‡
          const favorites = await window.favoritesAPI.getFavorites();
          favoriteCount.textContent = favorites.length;

          // è¨ˆç®—å·²é¸èª²ç¨‹æ•¸é‡
          const interestedCourses = currentUser.interestedCourses || [];
          totalCourses.textContent = interestedCourses.length;

          // è¨ˆç®—å­¸ç¿’å¤©æ•¸ï¼ˆæ¨¡æ“¬ï¼‰
          const registrationDate = new Date(currentUser.createdAt || Date.now());
          const daysSinceRegistration = Math.floor((Date.now() - registrationDate.getTime()) / (1000 * 60 * 60 * 24));
          learningDays.textContent = Math.max(1, daysSinceRegistration);

        } catch (error) {
          console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
        }
      }

      // åˆ‡æ›ç·¨è¼¯æ¨¡å¼
      function toggleEdit(section) {
        isEditing[section] = !isEditing[section];

        if (section === 'basicInfo') {
          const inputs = ['fullName', 'username', 'email', 'phone'];
          inputs.forEach(id => {
            const input = document.getElementById(id);
            input.readOnly = !isEditing[section];
            input.style.backgroundColor = isEditing[section] ? '#ffffff' : '#f8f9fa';
          });
        } else if (section === 'learningPrefs') {
          const programmingLevel = document.getElementById('programmingLevel');
          const learningGoals = document.getElementById('learningGoals');
          const goalsTemplates = document.getElementById('goalsTemplates');

          programmingLevel.disabled = !isEditing[section];
          learningGoals.readOnly = !isEditing[section];

          programmingLevel.style.backgroundColor = isEditing[section] ? '#ffffff' : '#f8f9fa';
          learningGoals.style.backgroundColor = isEditing[section] ? '#ffffff' : '#f8f9fa';

          // é¡¯ç¤ºæˆ–éš±è—å­¸ç¿’ç›®æ¨™ç¯„æœ¬
          if (goalsTemplates) {
            goalsTemplates.style.display = isEditing[section] ? 'block' : 'none';
          }
        }
      }

      // å„²å­˜å€‹äººè³‡æ–™
      async function saveProfile() {
        try {
          const updatedUser = {
            ...currentUser,
            fullName: document.getElementById('fullName').value,
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            programmingLevel: document.getElementById('programmingLevel').value,
            learningGoals: document.getElementById('learningGoals').value
          };

          // æ›´æ–°ä½¿ç”¨è€…è³‡æ–™ - ä½¿ç”¨ userRepository è€Œä¸æ˜¯ userRepo
          let result;
          if (window.userRepository && window.userRepository.updateUser) {
            result = await window.userRepository.updateUser(currentUser.id, updatedUser);
          } else if (window.userRepo && window.userRepo.updateUser) {
            result = await window.userRepo.updateUser(currentUser.id, updatedUser);
          } else {
            // Fallback to localStorage update
            const userRepo = new UserRepository();
            result = await userRepo.updateUser(currentUser.id, updatedUser);
          }

          if (result && result.success) {
            // æ›´æ–° session
            window.sessionManager.updateUser(updatedUser);
            currentUser = updatedUser;

            // æ›´æ–°é¡¯ç¤º
            loadUserProfile();

            // é—œé–‰ç·¨è¼¯æ¨¡å¼
            Object.keys(isEditing).forEach(key => {
              if (isEditing[key]) {
                toggleEdit(key);
              }
            });

            showNotification('å€‹äººè³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
          } else {
            showNotification('æ›´æ–°å¤±æ•—ï¼š' + (result?.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
          }
        } catch (error) {
          console.error('å„²å­˜å€‹äººè³‡æ–™å¤±æ•—:', error);
          showNotification('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
        }
      }

      // é‡è¨­å€‹äººè³‡æ–™
      function resetProfile() {
        if (confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è®Šæ›´å—ï¼Ÿ')) {
          loadUserProfile();
          Object.keys(isEditing).forEach(key => {
            if (isEditing[key]) {
              toggleEdit(key);
            }
          });
          showNotification('å·²é‡è¨­æ‰€æœ‰è®Šæ›´', 'info');
        }
      }

      // è®Šæ›´å¯†ç¢¼
      function changePassword() {
        const newPassword = prompt('è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼š');
        if (newPassword && newPassword.length >= 6) {
          // é€™è£¡æ‡‰è©²å¯¦ç¾å¯†ç¢¼è®Šæ›´é‚è¼¯
          showNotification('å¯†ç¢¼è®Šæ›´åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        } else if (newPassword) {
          showNotification('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'error');
        }
      }

      // é€šçŸ¥è¨­å®š
      function notificationSettings() {
        showNotification('é€šçŸ¥è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
      }

      // åŒ¯å‡ºè³‡æ–™
      function exportData() {
        const userData = {
          profile: currentUser,
          stats: {
            totalCourses: totalCourses.textContent,
            favoriteCount: favoriteCount.textContent,
            learningDays: learningDays.textContent
          },
          exportDate: new Date().toISOString()
        };

        const dataStr = JSON.stringify(userData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement('a');
        link.href = url;
        link.download = `user-data-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        URL.revokeObjectURL(url);
        showNotification('è³‡æ–™åŒ¯å‡ºå®Œæˆï¼', 'success');
      }

      // ç™»å‡º
      function logout() {
        if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
          window.sessionManager.logout();
          window.location.href = 'login.html';
        }
      }

      // è¨­å®šå­¸ç¿’ç›®æ¨™ç¯„æœ¬
      function setLearningGoal(goal) {
        const learningGoalsTextarea = document.getElementById('learningGoals');
        if (learningGoalsTextarea) {
          learningGoalsTextarea.value = goal;
          // å¦‚æœä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œè‡ªå‹•å•Ÿç”¨ç·¨è¼¯
          if (learningGoalsTextarea.readOnly) {
            toggleEdit('learningGoals');
          }
        }
      }

      // é¡¯ç¤ºèª²ç¨‹é¸æ“‡æ¨¡æ…‹æ¡†
      let selectedCourseTitles = [];

      function showCourseSelectionModal() {
        const modal = document.getElementById('courseSelectionModal');
        const modalCourseList = document.getElementById('modalCourseList');

        if (!modal || !modalCourseList) return;

        // è¼‰å…¥ç•¶å‰å·²é¸çš„èª²ç¨‹
        selectedCourseTitles = currentUser.interestedCourses || [];

        // è¼‰å…¥æ‰€æœ‰èª²ç¨‹åˆ°æ¨¡æ…‹æ¡†
        const allCourses = courses || window.coursesData || [];

        modalCourseList.innerHTML = allCourses.map(course => {
          const isSelected = selectedCourseTitles.includes(course.title);
          return `
            <div class="course-selection-item ${isSelected ? 'selected' : ''}" 
                 onclick="toggleCourseSelection('${course.title}')">
              <h4>${course.title}</h4>
              <p>${course.language || 'å¤šèªè¨€'}</p>
              <span class="course-selection-badge" style="background: ${course.level === 'é«˜ç´š' ? '#ff6b6b' : course.level === 'ä¸­ç´š' ? '#4ecdc4' : '#95e1d3'}">${course.level}</span>
            </div>
          `;
        }).join('');

        modal.style.display = 'block';
      }

      // é—œé–‰èª²ç¨‹é¸æ“‡æ¨¡æ…‹æ¡†
      function closeCourseSelectionModal() {
        const modal = document.getElementById('courseSelectionModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // åˆ‡æ›èª²ç¨‹é¸æ“‡
      function toggleCourseSelection(courseTitle) {
        const index = selectedCourseTitles.indexOf(courseTitle);
        if (index > -1) {
          selectedCourseTitles.splice(index, 1);
        } else {
          selectedCourseTitles.push(courseTitle);
        }

        // æ›´æ–°è¦–è¦ºæ•ˆæœ
        const item = event.currentTarget;
        item.classList.toggle('selected');
      }

      // å„²å­˜é¸ä¸­çš„èª²ç¨‹
      async function saveSelectedCourses() {
        try {
          // æ›´æ–°ç•¶å‰ç”¨æˆ¶çš„æ„Ÿèˆˆè¶£èª²ç¨‹
          currentUser.interestedCourses = selectedCourseTitles;

          // æ›´æ–°è³‡æ–™åº«
          let result;
          if (window.userRepository && window.userRepository.updateUser) {
            result = await window.userRepository.updateUser(currentUser.id, currentUser);
          } else if (window.userRepo && window.userRepo.updateUser) {
            result = await window.userRepo.updateUser(currentUser.id, currentUser);
          } else {
            // Fallback to localStorage update
            const userRepo = new UserRepository();
            result = await userRepo.updateUser(currentUser.id, currentUser);
          }

          if (result && result.success) {
            // æ›´æ–° session
            window.sessionManager.updateUser(currentUser);

            // æ›´æ–°é¡¯ç¤º
            updateSelectedCourses();
            loadUserStats();

            // é—œé–‰æ¨¡æ…‹æ¡†
            closeCourseSelectionModal();

            showNotification('å·²æ›´æ–°æ„Ÿèˆˆè¶£çš„èª²ç¨‹ï¼', 'success');
          } else {
            showNotification('æ›´æ–°å¤±æ•—ï¼š' + (result?.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
          }
        } catch (error) {
          console.error('å„²å­˜èª²ç¨‹é¸æ“‡å¤±æ•—:', error);
          showNotification('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
        }
      }

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      window.onclick = function (event) {
        const modal = document.getElementById('courseSelectionModal');
        if (event.target === modal) {
          closeCourseSelectionModal();
        }
      }

      // é¡¯ç¤ºé€šçŸ¥
      function showNotification(message, type = 'info') {
        if (window.createNotification) {
          window.createNotification(message, type);
        } else {
          alert(message);
        }
      }
    </script>
    <style>
      /* å­¸ç¿’ç›®æ¨™ç¯„æœ¬æ¨£å¼ */
      .template-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .template-btn {
        padding: 10px 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        text-align: left;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
      }

      .template-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      .template-btn:active {
        transform: translateY(0);
      }

      /* åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºç¯„æœ¬ */
      .info-item.editing #goalsTemplates {
        display: block !important;
      }

      /* å¢å¼·èª¿ textarea çš„è¦–è¦ºæ•ˆæœ */
      #learningGoals {
        transition: all 0.3s ease;
        border: 2px solid #e0e0e0;
      }

      #learningGoals:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      #learningGoals:not([readonly]) {
        background-color: #f8f9fa;
      }

      /* èª²ç¨‹é¸æ“‡æ¨¡æ…‹æ¡†æ¨£å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: none;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
      }

      .modal-close:hover {
        color: #000;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 10px;
        border-top: 2px solid #e0e0e0;
      }

      .courses-grid-selection {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
      }

      .course-selection-item {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .course-selection-item:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .course-selection-item.selected {
        border-color: #667eea;
        background-color: #e6eaff;
      }

      .course-selection-item h4 {
        margin: 0 0 5px 0;
        color: #333;
      }

      .course-selection-item p {
        margin: 0;
        color: #666;
        font-size: 0.9em;
      }

      .course-selection-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.8em;
        margin-top: 8px;
      }
    </style>
  </body>

</html>